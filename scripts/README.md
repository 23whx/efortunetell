# 开发脚本说明

这个目录包含了用于管理开发服务器和端口的实用脚本。

## 脚本列表

### `dev.js` - 开发服务器启动脚本

**功能特性：**
- 🧹 启动前自动清理端口 14761
- 🔄 自动管理进程生命周期
- ⚡ 捕获终端关闭信号，确保进程正确退出
- 🛡️ 处理异常情况，防止进程残留

**使用方法：**
```bash
npm run dev
```

**工作原理：**
1. 检查端口 14761 是否被占用
2. **如果端口被占用，询问用户是否清理** ⭐ 新功能
   - 显示占用端口的进程信息
   - 询问用户是否要清理并重新启动
   - 等待用户输入 (Y/n)
3. 根据用户选择：
   - 选择 Y: 清理端口并启动开发服务器
   - 选择 n: 取消启动，提示手动清理命令
4. 启动 Next.js 开发服务器
5. 监听终端关闭信号（SIGINT, SIGTERM, SIGHUP, SIGBREAK）
6. 当终端关闭或收到退出信号时，自动清理进程并释放端口

### `clean-port.js` - 端口清理脚本

**功能特性：**
- 🔍 检测端口 14761 的占用情况
- 🗑️ 强制终止占用端口的进程
- 🖥️ 跨平台支持（Windows/Linux/Mac）

**使用方法：**
```bash
npm run clean-port
```

## 交互式端口管理 ⭐ 新功能

脚本现在支持智能交互式端口检测：

### 启动时的交互流程

当你运行 `npm run dev` 时：

1. **自动检测端口** - 检查 14761 端口是否被占用
2. **如果端口空闲** - 直接启动开发服务器
3. **如果端口被占用** - 显示交互式提示：

```
⚠️  警告：端口 14761 正在被使用！
发现以下进程占用端口：
  - PID: 12345

是否清理端口并重新启动？(Y/n):
```

### 用户选择

- **输入 Y 或 yes 或直接回车**: 自动清理端口并启动
- **输入 n 或 no**: 取消启动，保留现有进程

### 优势

- ✅ **安全**: 不会意外终止重要进程
- ✅ **友好**: 清楚显示哪些进程占用端口
- ✅ **灵活**: 用户可以选择是否清理
- ✅ **智能**: 自动检测，无需手动查看

这样你就不会忘记如何处理端口占用问题了！ 😊

## 常见问题

### Q: 为什么端口会被占用？
A: 当开发服务器异常退出或终端被强制关闭时，Node.js 进程可能没有正确清理，导致端口仍被占用。

### Q: 如何确保进程在终端关闭时自动释放？
A: 使用 `npm run dev` 启动开发服务器。该命令会自动：
   - **在启动前检查端口（交互式）**
   - 监听终端关闭信号
   - 在退出时自动清理进程
   - 显示友好的提示信息

### Q: 如果 `npm run dev` 检测到端口被占用怎么办？
A: 脚本会：
   1. 显示占用端口的进程信息
   2. 询问你是否要清理端口
   3. 等待你的选择 (Y/n)
   4. 根据选择执行相应操作

### Q: 如果我选择不清理端口怎么办？
A: 脚本会：
   - 取消启动开发服务器
   - 提示你可以手动运行 `npm run clean-port`
   - 安全退出，不会影响现有进程

### Q: 如果我想直接清理端口怎么办？
A: 可以手动运行清理脚本：
   ```bash
   npm run clean-port
   ```
   然后再次尝试启动开发服务器。

### Q: Windows 上如何查看正在运行的 Node.js 进程？
A: 使用以下命令：
   ```cmd
   netstat -ano | findstr :14761
   ```
   或者查看所有 Node.js 进程：
   ```cmd
   tasklist | findstr node.exe
   ```

### Q: 如何手动终止进程？
A: Windows：
   ```cmd
   taskkill /PID <进程ID> /F
   ```
   Linux/Mac：
   ```bash
   kill -9 <进程ID>
   ```

## 技术实现

### 信号处理
脚本监听以下信号来确保正确清理：
- `SIGINT`: Ctrl+C
- `SIGTERM`: 标准终止信号
- `SIGHUP`: 终端断开连接
- `SIGBREAK`: Windows 特定的中断信号

### 进程管理
使用 Node.js 的 `child_process.spawn` 启动开发服务器，并：
- 继承父进程的 stdio（保持日志输出）
- 监听子进程的退出事件
- 在父进程退出前确保子进程也被终止

### 端口检测
- **Windows**: 使用 `netstat -ano | findstr :PORT`
- **Unix/Linux/Mac**: 使用 `lsof -ti:PORT`

## 开发建议

1. **总是使用 `npm run dev` 启动开发服务器**
   - 不要直接运行 `next dev`
   - 这样可以确保进程管理和清理功能生效

2. **正常退出开发服务器**
   - 使用 Ctrl+C 退出
   - 避免直接关闭终端窗口
   - 如果必须关闭终端，脚本会自动清理

3. **遇到端口占用问题时**
   - 运行 `npm run clean-port` 清理
   - 或者重启计算机（终极解决方案 😅）

4. **在 VS Code 中开发**
   - 使用内置终端运行 `npm run dev`
   - 配置的 `.vscode/settings.json` 会优化终端体验
   - 可以使用 `.vscode/tasks.json` 中的任务快速启动

## 维护

如果需要修改端口号：
1. 更新 `scripts/dev.js` 中的 `PORT` 常量
2. 更新 `scripts/clean-port.js` 中的 `PORT` 常量
3. 更新 `package.json` 中 `dev:direct` 脚本的端口参数

## 许可证

MIT

