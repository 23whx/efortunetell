<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯è®¤è¯è°ƒè¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” å‰ç«¯è®¤è¯çŠ¶æ€è°ƒè¯•</h1>
    
    <div class="section info">
        <h3>ğŸ“‹ localStorage æ•°æ®æ£€æŸ¥</h3>
        <button onclick="checkLocalStorage()">æ£€æŸ¥ localStorage</button>
        <div id="localStorage-result"></div>
    </div>
    
    <div class="section info">
        <h3>ğŸ”‘ è®¤è¯å¤´éƒ¨æµ‹è¯•</h3>
        <button onclick="testAuthHeaders()">æµ‹è¯• getAuthHeaders()</button>
        <div id="auth-headers-result"></div>
    </div>
    
    <div class="section info">
        <h3>ğŸ§ª ç”¨æˆ·ç™»å½•æµ‹è¯•</h3>
        <input type="text" id="username" placeholder="ç”¨æˆ·å" value="testuser">
        <input type="password" id="password" placeholder="å¯†ç " value="test123">
        <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
        <div id="login-result"></div>
    </div>
    
    <div class="section info">
        <h3>â­ æ”¶è—åŠŸèƒ½æµ‹è¯•</h3>
        <input type="text" id="articleId" placeholder="æ–‡ç« ID" value="680b070c5f0723d19c1eb1b2">
        <button onclick="testBookmark()">æµ‹è¯•æ”¶è—</button>
        <div id="bookmark-result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:5000';
        
        // æ£€æŸ¥localStorageæ•°æ®
        function checkLocalStorage() {
            const result = document.getElementById('localStorage-result');
            const data = {
                token: localStorage.getItem('token'),
                user: localStorage.getItem('user'),
                admin: localStorage.getItem('admin')
            };
            
            let html = '<h4>localStorage å†…å®¹:</h4>';
            for (const [key, value] of Object.entries(data)) {
                html += `<p><strong>${key}:</strong> ${value || '(ç©º)'}</p>`;
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        html += `<pre>${JSON.stringify(parsed, null, 2)}</pre>`;
                    } catch (e) {
                        html += `<pre>${value}</pre>`;
                    }
                }
            }
            result.innerHTML = html;
        }
        
        // æ¨¡æ‹ŸgetAuthHeaderså‡½æ•°
        function getAuthHeaders() {
            try {
                let token = '';
                
                // é¦–å…ˆå°è¯•ç›´æ¥ä»tokenå­—æ®µè·å–
                const directToken = localStorage.getItem('token');
                if (directToken) {
                    token = directToken;
                }
                
                // å¦‚æœç›´æ¥tokenä¸å­˜åœ¨ï¼Œå°è¯•ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–token
                if (!token) {
                    const userJson = localStorage.getItem('user');
                    if (userJson) {
                        const user = JSON.parse(userJson);
                        if (user && user.token) {
                            token = user.token;
                        }
                    }
                }
                
                // å¦‚æœç”¨æˆ·tokenä¸å­˜åœ¨ï¼Œå°è¯•ä»ç®¡ç†å‘˜ä¿¡æ¯ä¸­è·å–
                if (!token) {
                    const adminJson = localStorage.getItem('admin');
                    if (adminJson) {
                        const admin = JSON.parse(adminJson);
                        if (admin && admin.token) {
                            token = admin.token;
                        }
                    }
                }
                
                return {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : '',
                };
            } catch (error) {
                console.error('è¯»å–ç”¨æˆ·ä»¤ç‰Œå¤±è´¥:', error);
                return {
                    'Content-Type': 'application/json',
                    'Authorization': '',
                };
            }
        }
        
        // æµ‹è¯•è®¤è¯å¤´éƒ¨
        function testAuthHeaders() {
            const result = document.getElementById('auth-headers-result');
            const headers = getAuthHeaders();
            
            result.innerHTML = `
                <h4>è®¤è¯å¤´éƒ¨ç»“æœ:</h4>
                <pre>${JSON.stringify(headers, null, 2)}</pre>
                <p><strong>çŠ¶æ€:</strong> ${headers.Authorization ? 'âœ… æœ‰token' : 'âŒ æ— token'}</p>
            `;
        }
        
        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const result = document.getElementById('login-result');
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            result.innerHTML = '<p>ğŸ”„ æ­£åœ¨ç™»å½•...</p>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password }),
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // ä¿å­˜tokenå’Œç”¨æˆ·ä¿¡æ¯
                    if (data.token) {
                        localStorage.setItem('token', data.token);
                    }
                    if (data.data && data.data.user) {
                        localStorage.setItem('user', JSON.stringify({
                            username: data.data.user.username,
                            _id: data.data.user._id
                        }));
                    }
                    
                    result.innerHTML = `
                        <div class="success">
                            <h4>âœ… ç™»å½•æˆåŠŸ!</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">
                            <h4>âŒ ç™»å½•å¤±è´¥</h4>
                            <p>é”™è¯¯: ${data.message}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <h4>âŒ ç½‘ç»œé”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // æµ‹è¯•æ”¶è—åŠŸèƒ½
        async function testBookmark() {
            const result = document.getElementById('bookmark-result');
            const articleId = document.getElementById('articleId').value;
            
            result.innerHTML = '<p>ğŸ”„ æ­£åœ¨æµ‹è¯•æ”¶è—...</p>';
            
            try {
                const headers = getAuthHeaders();
                const response = await fetch(`${API_BASE_URL}/api/articles/${articleId}/bookmark`, {
                    method: 'PUT',
                    headers
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    result.innerHTML = `
                        <div class="success">
                            <h4>âœ… æ”¶è—æ“ä½œæˆåŠŸ!</h4>
                            <p>æ”¶è—çŠ¶æ€: ${data.bookmarked ? 'å·²æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—'}</p>
                            <p>æ”¶è—æ•°: ${data.bookmarks}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    result.innerHTML = `
                        <div class="error">
                            <h4>âŒ æ”¶è—æ“ä½œå¤±è´¥</h4>
                            <p>çŠ¶æ€ç : ${response.status}</p>
                            <p>é”™è¯¯: ${data.message}</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                result.innerHTML = `
                    <div class="error">
                        <h4>âŒ ç½‘ç»œé”™è¯¯</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥localStorage
        window.onload = function() {
            checkLocalStorage();
            testAuthHeaders();
        };
    </script>
</body>
</html> 